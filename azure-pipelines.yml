# yaml
trigger:
  - main

pool:
  name: 'Default'
  demands:
    - Agent.Version -gtVersion 2.200.0

variables:
  MAVEN_OPTS: '-Xmx512m -XX:+UseG1GC'
  AZURE_SERVICE_CONNECTION: 'azure-subscription-RM'  # nome da AzureRM service connection

stages:
  - stage: Build
    displayName: 'Build and Package'
    jobs:
      - job: BuildJob
        displayName: 'Maven build'
        steps:
          - checkout: self
          - task: Bash@3
            displayName: 'Verify Java 17 is installed'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking Java 17 on the agent..."
                if ! command -v java >/dev/null 2>&1; then
                  echo "##[error]Java not found on agent. Install OpenJDK 17 and retry."
                  exit 1
                fi
                if ! java -version 2>&1 | grep -E '"17' >/dev/null 2>&1; then
                  echo "##[error]Java 17 is not installed on this agent. Install OpenJDK 17 and retry."
                  java -version 2>&1 || true
                  exit 1
                fi
                echo "Java 17 is installed:";
                java -version
                if command -v mvn >/dev/null 2>&1; then
                  mvn -version || true
                fi
          - task: Maven@4
            displayName: 'Maven - clean package'
            inputs:
              mavenPomFile: 'mottu-api/pom.xml'
              goals: 'clean package'
              options: '-DskipTests'
              # Use system-installed Java on the self-hosted agent; do not request JDKVersion from the task
          - task: Bash@3
            displayName: 'Find JAR and set variable'
            inputs:
              targetType: 'inline'
              script: |
                echo "Locating JAR in $(Build.SourcesDirectory)/mottu-api/target"
                jar=$(ls "$(Build.SourcesDirectory)/mottu-api/target"/*.jar 2>/dev/null | head -n1 || true)
                if [ -z "$jar" ]; then
                  echo "##[error]JAR not found in $(Build.SourcesDirectory)/mottu-api/target"
                  exit 1
                fi
                name=$(basename "$jar")
                echo "Found JAR: $name"
                echo "##vso[task.setvariable variable=JAR_NAME]$name"
          - task: CopyFiles@2
            displayName: 'Copy JAR to staging'
            inputs:
              sourceFolder: '$(Build.SourcesDirectory)/mottu-api/target'
              contents: '*.jar'
              targetFolder: '$(Build.ArtifactStagingDirectory)'
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'mottu-api'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Azure Web App'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: 'Deploy JAR'
        dependsOn: SetAppSettingsAz
        steps:
          - checkout: none
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'mottu-api'
              downloadPath: '$(System.ArtifactsDirectory)'
          - task: Bash@3
            displayName: 'Debug: list downloaded artifact files'
            inputs:
              targetType: 'inline'
              script: |
                echo "Listing contents of $(System.ArtifactsDirectory)/mottu-api"
                ls -la "$(System.ArtifactsDirectory)/mottu-api" || true
                echo "First matching jar:" 
                ls "$(System.ArtifactsDirectory)/mottu-api"/*.jar 2>/dev/null | head -n1 || echo "No jar found"
          - task: Bash@3
            displayName: 'Select deploy JAR and set DEPLOY_JAR'
            inputs:
              targetType: 'inline'
              script: |
                echo "Selecting JAR to deploy from $(System.ArtifactsDirectory)/mottu-api"
                jar=$(ls "$(System.ArtifactsDirectory)/mottu-api"/*.jar 2>/dev/null | head -n1 || true)
                if [ -z "$jar" ]; then
                  echo "##[error]No jar found in $(System.ArtifactsDirectory)/mottu-api"
                  exit 1
                fi
                echo "Found deploy jar: $jar"
                name=$(basename "$jar")
                # set a pipeline variable for the package path
                echo "##vso[task.setvariable variable=DEPLOY_JAR]$jar"
                echo "##vso[task.setvariable variable=DEPLOY_JAR_NAME]$name"
          - task: AzureWebApp@1
            displayName: 'Deploy to App Service'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: 'mottu-api-1762730933'
              # Use the exact jar path selected in the previous step
              package: '$(DEPLOY_JAR)'
              appType: 'webAppLinux'
              runtimeStack: 'JAVA|17-java17'
              # Start the specific jar
              startupCommand: 'java -Dserver.port=$PORT -jar /home/site/wwwroot/$(DEPLOY_JAR_NAME)'
              # Pass app settings as a JSON array of strings to avoid parsing issues
              appSettings: '["SPRING_PROFILES_ACTIVE=postgres","DB_URL=jdbc:postgresql://pg-flex-sprint4.postgres.database.azure.com:5432/appdb?sslmode=require","DB_USERNAME=$(DB_USERNAME)","DB_PASSWORD=$(DB_PASSWORD)"]'
      - job: SetAppSettingsAz
        displayName: '(Optional) Set App Settings via Azure CLI (self-hosted)'
        pool:
          name: 'Default'  # use existing self-hosted agent pool instead of hosted 'ubuntu-latest'
        steps:
          - bash: |
              set -euo pipefail
              if [ -z "${AZURE_RESOURCE_GROUP}" ]; then
                echo "##[warning]AZURE_RESOURCE_GROUP is not set. Skipping Azure CLI app settings step."
                exit 0
              fi

              echo "Ensure Azure CLI is available..."
              if ! command -v az >/dev/null 2>&1; then
                echo "Azure CLI not found. Installing..."
                if [ -x "$(command -v apt-get 2>/dev/null || true)" ]; then
                  # Debian/Ubuntu install
                  curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
                elif [ -x "$(command -v yum 2>/dev/null || true)" ]; then
                  # RHEL/CentOS
                  sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
                  sudo sh -c 'echo -e "[azure-cli]\nname=Azure CLI\nbaseurl=https://packages.microsoft.com/yumrepos/azure-cli\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
                  sudo yum install -y azure-cli
                else
                  echo "##[warning]Unsupported OS for automatic Azure CLI install. Please install 'az' manually on the agent."
                  exit 0
                fi
              else
                echo "Azure CLI already installed: $(az --version | head -n1)"
              fi

              # If service principal creds are provided, login; otherwise assume managed identity or prior login
              if [ -n "${AZURE_CLIENT_ID:-}" ] && [ -n "${AZURE_CLIENT_SECRET:-}" ] && [ -n "${AZURE_TENANT_ID:-}" ]; then
                echo "Logging in with Service Principal..."
                az login --service-principal -u "${AZURE_CLIENT_ID}" -p "${AZURE_CLIENT_SECRET}" --tenant "${AZURE_TENANT_ID}"
                if [ -n "${AZURE_SUBSCRIPTION_ID:-}" ]; then
                  az account set --subscription "${AZURE_SUBSCRIPTION_ID}"
                fi
              else
                echo "Service Principal not provided. Assuming agent already authenticated (managed identity or previously logged in)."
              fi

              echo "Setting app settings via Azure CLI for app: mottu-api-1762730933 (resource group: ${AZURE_RESOURCE_GROUP})"
              az webapp config appsettings set --name mottu-api-1762730933 --resource-group "${AZURE_RESOURCE_GROUP}" --settings \
                SPRING_PROFILES_ACTIVE=postgres \
                "DB_URL=jdbc:postgresql://pg-flex-sprint4.postgres.database.azure.com:5432/appdb?sslmode=require" \
                DB_USERNAME="${DB_USERNAME}" DB_PASSWORD="${DB_PASSWORD}"
            displayName: 'Ensure az and set app settings (self-hosted)'
            env:
              AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)
              DB_USERNAME: $(DB_USERNAME)
              DB_PASSWORD: $(DB_PASSWORD)
              AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
              AZURE_CLIENT_SECRET: $(AZURE_CLIENT_SECRET)
              AZURE_TENANT_ID: $(AZURE_TENANT_ID)
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
          - bash: |
              if [ -z "${AZURE_RESOURCE_GROUP}" ]; then
                echo "AZURE_RESOURCE_GROUP not set; skipping validation"
                exit 0
              fi
              if ! command -v az >/dev/null 2>&1; then
                echo "##[warning]Azure CLI (az) not found on this agent. To enable validation via az, install Azure CLI on the self-hosted agent or run this job on a hosted image."
                echo "To install on Ubuntu: curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash"
                exit 0
              fi
              echo "Listing current app settings for mottu-api-1762730933"
              az webapp config appsettings list --name mottu-api-1762730933 --resource-group "${AZURE_RESOURCE_GROUP}"
            displayName: 'Validate webapp settings via az (if available)'
            env:
              AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)
