trigger:
  - main

pool:
  name: 'Default'

variables:
  MAVEN_OPTS: '-Xmx512m' # reduced to lower memory pressure on self-hosted VM

stages:
  - stage: Build
    displayName: 'Build and Package'
    jobs:
      - job: Build
        displayName: 'Maven build'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Verify Java 17 and Maven are installed'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking Java 17 and Maven on the agent..."
                if ! command -v java >/dev/null 2>&1; then
                  echo "##[error]Java not found on agent. Install OpenJDK 17 and retry."
                  exit 1
                fi
                if ! java -version 2>&1 | grep -E '"17' >/dev/null 2>&1; then
                  echo "##[error]Java 17 is not installed on this agent. Install OpenJDK 17 and retry."
                  java -version 2>&1 || true
                  exit 1
                fi
                if ! command -v mvn >/dev/null 2>&1; then
                  echo "##[error]Maven not found on agent. Install Maven and retry."
                  exit 1
                fi
                mvn -version

          - task: Bash@3
            displayName: 'Ensure Maven cache directory exists'
            inputs:
              targetType: 'inline'
              script: |
                echo "Creating Maven cache directory under Agent.HomeDirectory"
                mkdir -p "$(Agent.HomeDirectory)/.m2/repository"
                sudo chown -R $(whoami) "$(Agent.HomeDirectory)/.m2" || true

          - task: Cache@2
            displayName: 'Restore Maven cache'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              path: '$(Agent.HomeDirectory)/.m2/repository'
              restoreKeys: |
                maven | "$(Agent.OS)"

          - task: Maven@4
            displayName: 'Maven - download dependencies (go-offline)'
            inputs:
              mavenPomFile: 'mottu-api/pom.xml'
              goals: 'dependency:go-offline'
              options: '-DskipTests -B -U -T 1C'
              mavenOptions: '$(MAVEN_OPTS)'

          - task: Maven@4
            displayName: 'Maven - clean package'
            inputs:
              mavenPomFile: 'mottu-api/pom.xml'
              goals: 'clean package'
              options: '-DskipTests'
              publishJUnitResults: false
              mavenOptions: '$(MAVEN_OPTS)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact'
            inputs:
              PathtoPublish: 'mottu-api/target'
              ArtifactName: 'mottu-api'
              publishLocation: 'Container'
  - stage: Test
    displayName: 'Run Tests'
    jobs:
      - job: Test
        displayName: 'Maven test'
        steps:
          - checkout: self

          - task: Bash@3
            displayName: 'Verify Java 17 and Maven are installed (tests)'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking Java 17 and Maven on the agent (tests)..."
                if ! command -v java >/dev/null 2>&1; then
                  echo "##[error]Java not found on agent. Install OpenJDK 17 and retry."
                  exit 1
                fi
                if ! java -version 2>&1 | grep -E '"17' >/dev/null 2>&1; then
                  echo "##[error]Java 17 is not installed on this agent. Install OpenJDK 17 and retry."
                  java -version 2>&1 || true
                  exit 1
                fi
                if ! command -v mvn >/dev/null 2>&1; then
                  echo "##[error]Maven not found on agent. Install Maven and retry."
                  exit 1
                fi
                mvn -version

          - task: Maven@4
            displayName: 'Maven - run tests'
            inputs:
              mavenPomFile: 'mottu-api/pom.xml'
              goals: 'test'
              # Using system-installed Java on the self-hosted agent; do not set javaHomeOption
            env:
              DB_HOST: '$(DB_HOST)'
              DB_PORT: '$(DB_PORT)'
              DB_NAME: '$(DB_NAME)'
              DB_USERNAME: '$(DB_USERNAME)'
              DB_PASSWORD: '$(DB_PASSWORD)'
              SPRING_PROFILES_ACTIVE: 'postgres'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
            condition: always()
