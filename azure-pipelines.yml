# yaml
trigger:
  - main

pool:
  name: 'Default'
  demands:
    - Agent.Version -gtVersion 2.200.0

stages:
  - stage: BuildAndDeploy
    displayName: 'Build and Deploy'
    jobs:
      - job: BuildAndDeployJob
        displayName: 'Build (Maven) and Deploy'
        steps:
          - checkout: self

          - task: Maven@4
            displayName: 'Maven - clean package'
            inputs:
              mavenPomFile: 'mottu-api/pom.xml'
              goals: 'clean package'
              options: '-DskipTests'

          - bash: |
              echo "Locating JAR to deploy..."
              jar=$(ls "$(Build.SourcesDirectory)/mottu-api/target"/*.jar 2>/dev/null | head -n1 || true)
              if [ -z "$jar" ]; then
                echo "##[error]JAR not found in $(Build.SourcesDirectory)/mottu-api/target"
                exit 1
              fi
              echo "Found JAR: $jar"
              echo "##vso[task.setvariable variable=DEPLOY_JAR]$jar"
            displayName: 'Find and set DEPLOY_JAR'

          - task: AzureWebApp@1
            displayName: 'Deploy to App Service'
            inputs:
              azureSubscription: 'azure-subscription-RM'
              appName: 'mottu-api-1762730933'
              package: '$(DEPLOY_JAR)'
              appType: 'webAppLinux'
              runtimeStack: 'JAVA|17-java17'
              # no appSettings to avoid modifying application settings
              # optional startup command if your app needs it (uncomment to use)
              # startupCommand: 'java -Dserver.port=$PORT -jar /home/site/wwwroot/$(notdir $(DEPLOY_JAR)))'
